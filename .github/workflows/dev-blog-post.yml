# ================================================================
#  ðŸš€ GitHub Actions Workflow: Update README with Latest & Top Blog Posts
# ================================================================
#  ðŸ”¹ This workflow automatically updates the README.md file with:
#     1âƒ£ The latest blog posts from **Dev.to**.
#     2âƒ£ The top-performing blog posts (based on positive reactions).
#
#  âœ… Runs **weekly (every Monday at 00:00 UTC)** to reduce API calls.
#  âœ… Can be manually triggered from the GitHub Actions UI.
#  âœ… Uses `gautamkrishnar/blog-post-workflow` to fetch latest posts.
#  âœ… Uses `curl` & `jq` to fetch and filter top-performing posts.
#
#  ðŸ“Œ Steps:
#  1âƒ£ Checks out the repository.
#  2âƒ£ Fetches the latest blog posts from **Dev.to RSS Feed**.
#  3âƒ£ Fetches **all** Dev.to blog posts & filters top-performing ones.
#  4âƒ£ Updates the README.md file dynamically.
#  5âƒ£ Commits and pushes the changes to the repository.
#
#  ðŸš€ No personal access token (PAT) required! Uses `GITHUB_TOKEN`.
# ================================================================

name: Update README with Latest & Top Dev.to Posts

on:
  schedule:
    - cron: '0 0 * * 1'   # âœ… Runs weekly (Monday at 00:00 UTC)
  workflow_dispatch:       # âœ… Allows manual trigger

permissions:
  contents: write # âœ… Required to update README.md

jobs:
  update-readme-with-blog:
    name: Update README with Latest & Top Blog Posts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4 # âœ… Clones the repository

      # âœ… Fetches Latest Dev.to Blog Posts & Inserts in BLOG-POST-LIST
      - name: Fetch Latest Dev.to Blog Posts
        uses: gautamkrishnar/blog-post-workflow@v1
        with:
          feed_list: "https://dev.to/feed/madhurima_rawat" # âœ… Fetches latest posts from Dev.to profile
          max_post_count: 5  # âœ… Fetches up to 5 latest posts

      # âœ… Fetches Top Performing Dev.to Blog Posts (All-time)
      - name: Fetch Top Performing Dev.to Posts
        run: |
          # âœ… Remove old "ðŸ”¥ Top Performing" section
          sed -i '/<!-- TOP-POST-LIST:START -->/,/<!-- TOP-POST-LIST:END -->/d' README.md
          
          # âœ… Create new section with top-performing posts (20+ reactions)
          echo "<!-- TOP-POST-LIST:START -->" > top_posts.md
          page=1
          while :; do
            response=$(curl -s "https://dev.to/api/articles?username=madhurima_rawat&page=$page&per_page=100")
            count=$(echo "$response" | jq length)
            [[ $count -eq 0 ]] && break # âœ… Stop if no more posts
            
            echo "$response" | jq -r '.[] | select(.positive_reactions_count >= 35) | "- [\(.title)](\(.url))"' >> top_posts.md
            page=$((page + 1))
          done
          echo "<!-- TOP-POST-LIST:END -->" >> top_posts.md
          
          # âœ… Insert updated top posts inside README
          sed -i '/#### ðŸ”¥ Top Performing/r top_posts.md' README.md

      - name: Commit & Push Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # âœ… Uses GitHub token for authentication
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "ðŸ”„ Updated latest & top-performing blog posts" || exit 0 # âœ… Skips commit if no changes
          git push origin main
